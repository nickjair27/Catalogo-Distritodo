<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Distritodo</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
    
    <link rel="icon" href="https://lh3.googleusercontent.com/d/17BziO1WCOIJDzyWmN5ZhKuoIi_q1PWXb">

    <style>
        *{box-sizing:border-box}
        /* TIPOGRAF√çA Y FONDO CORPORATIVO */
        body{margin:0;font-family:'Montserrat', 'Inter', sans-serif;background:#FFFFFF}
        
        /* HEADER Y LOGO - COLOR AZUL CONFIANZA */
        .header-container{background:#0D2A52;padding:10px;position:sticky;top:0;z-index:100;box-shadow: 0 2px 5px rgba(0,0,0,0.2)}
        .logo-main{display:block;margin:0 auto 10px;height:50px;max-width:100%;object-fit:contain}
        header{display:flex;gap:10px;align-items:center}
        #menuBtn{font-size:26px;cursor:pointer;color:white}
        #buscar{flex:1;padding:10px;border-radius:8px;border:none;outline:none;font-size:16px}

        /* SIDEBAR */
        #sidebar{position:fixed;top:0;left:-280px;width:280px;height:100%;background:white;box-shadow:4px 0 15px rgba(0,0,0,0.3);transition:.3s;padding:20px;z-index:1000;overflow-y:auto}
        #sidebar.activo{left:0}
        /* GRIS T√âCNICO EN TEXTOS */
        .cat{padding:12px;border-bottom:1px solid #eee;cursor:pointer;font-weight:bold;color:#2F2F2F}
        .cat:hover{background:#f9f9f9}
        /* AZUL CONFIANZA */
        #verTodos{background:#0D2A52;color:white;padding:10px;border-radius:8px;text-align:center;margin-bottom:15px;cursor:pointer}
        .btn-cerrar-menu{width:100%;padding:10px;background:#eee;border:none;border-radius:8px;margin-bottom:15px;cursor:pointer;font-weight:bold}

        /* MARCAS */
        #marcas{display:flex;gap:15px;overflow-x:auto;padding:15px;background:white}
        .marca{text-align:center;font-size:12px;min-width:80px;cursor:pointer}
        /* BORDE AZUL CONFIANZA */
        .marca img{width:65px;height:65px;border-radius:50%;border:2px solid #0D2A52;object-fit:cover;background:#f9f9f9}

        /* PRODUCTOS */
        /* COLOR AZUL CONFIANZA EN T√çTULOS */
        .seccion-titulo{padding:15px 10px 5px;font-size:18px;color:#0D2A52;font-weight:bold;text-transform:uppercase}
        #productos{padding:10px;display:grid;grid-template-columns:repeat(2,1fr);gap:12px;margin-bottom:110px}
        @media(min-width:700px){#productos{grid-template-columns:repeat(3,1fr);max-width:1000px;margin-left:auto;margin-right:auto}}

        .producto{background:white;border-radius:12px;padding:10px;text-align:center;box-shadow:0 2px 6px rgba(0,0,0,.1);position:relative;display:flex;flex-direction:column;justify-content:space-between}
        .producto img{width:100%;border-radius:8px;aspect-ratio:1/1;object-fit:cover}
        
        /* PREMIUM - COLOR AMARILLO ACCI√ìN */
        .producto.premium {border: 2px solid #F4B400; background: #FFFFFF; box-shadow: 0 4px 12px rgba(244,180,0,0.2)}
        .premium-tag {position:absolute; top:5px; left:5px; background:#F4B400; color:#000; font-size:10px; padding:2px 6px; border-radius:4px; font-weight:bold; z-index: 5;}

        .badge-desc{position:absolute;top:5px;right:5px;background:#e74c3c;color:white;font-size:12px;padding:4px 8px;border-radius:8px;font-weight:bold; z-index: 5;}
        .precio-old{text-decoration:line-through;color:#999;font-size:12px;margin-right:5px}
        .nombre{font-size:14px;margin:8px 0;height:34px;overflow:hidden;line-height:1.2}
        /* PRECIO EN AZUL CONFIANZA */
        .precio{color:#0D2A52;font-weight:bold;font-size:16px}
        
        /* BOT√ìN INFO - MEJORA: POSICI√ìN ABAJO DERECHA */
        .btn-info {
            position: absolute; 
            bottom: 5px; right: 5px;
            background: rgba(255,255,255,0.9); width: 28px; height: 28px;
            border-radius: 50%; border: 1px solid #ddd;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; z-index: 10; font-size: 16px; color: #0D2A52;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .controles{display:flex;justify-content:center;gap:6px;margin-top:10px}
        /* BOTONES EN AZUL CONFIANZA */
        .controles button{width:32px;height:32px;background:#0D2A52;color:white;border:none;border-radius:6px;cursor:pointer}
        .controles input{width:50px;text-align:center;border:1px solid #ccc;border-radius:6px}

        /* BURBUJA Y PANEL */
        /* BURBUJA EN AZUL CONFIANZA */
        #burbuja{position:fixed;bottom:20px;right:20px;background:#0D2A52;color:white;padding:12px 20px;border-radius:30px;z-index:90;box-shadow:0 4px 15px rgba(0,0,0,0.3);cursor:pointer;font-weight:bold}
        #panel{position:fixed;left:0;right:0;bottom:-100%;background:white;height:90%;transition:.4s;border-radius:20px 20px 0 0;padding:20px;overflow-y:auto;z-index:2000;box-shadow:0 -5px 20px rgba(0,0,0,0.2)}
        #panel.activo{bottom:0}

        .cliente-selector{background:#f9f9f9;padding:10px;border-radius:10px;margin-bottom:15px;border:1px solid #eee}
        .cliente-selector input, .cliente-selector select{width:100%; padding:10px; margin:5px 0; border-radius:6px; border:1px solid #ccc}
        .item{display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid #eee}
        
        #enviar{width:100%;padding:15px;background:#25D366;border:none;border-radius:12px;color:white;font-weight:bold;font-size:16px;margin-top:10px;cursor:pointer}
        #enviar:disabled, #btn-imprimir:disabled{background:#ccc;cursor:not-allowed}
        
        #btn-imprimir{width:100%;padding:15px;background:#2F2F2F;border:none;border-radius:12px;color:white;font-weight:bold;font-size:16px;margin-top:10px;cursor:pointer}
        .btn-vaciar{background:#eee;color:#2F2F2F;border:none;padding:10px;width:100%;border-radius:8px;margin-top:10px;cursor:pointer}
        .btn-soporte{position:fixed;bottom:85px;right:20px;background:#00a884;color:white;width:50px;height:50px;border-radius:50%;display:flex;align-items:center;justify-content:center;text-decoration:none;box-shadow:0 4px 10px rgba(0,0,0,0.2);z-index:80;font-size:24px}

        /* MODAL DE CONFIRMACI√ìN / PREVENTA */
        #modal-confirmacion, #modal-info {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 3000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .modal-content {
            background: white;
            border-radius: 20px;
            width: 100%;
            max-width: 400px;
            padding: 25px;
            text-align: center;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            position: relative;
            max-height: 90vh; 
            overflow-y: auto; 
            display: flex;
            flex-direction: column;
        }
        .modal-logo { height: 40px; margin-bottom: 10px; align-self: center; }
        /* T√çTULO EN AZUL CONFIANZA */
        .modal-title { color: #0D2A52; font-weight: bold; font-size: 22px; margin-bottom: 15px; text-transform: uppercase; }
        .resumen-caja { background: #f9f9f9; padding: 15px; border-radius: 12px; text-align: left; margin-bottom: 20px; border: 1px solid #eee; }
        .resumen-linea { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 14px; }
        .pregunta-dia { font-weight: bold; margin-bottom: 15px; display: block; color: #2F2F2F; }
        
        /* ESTILOS ESPEC√çFICOS DEL MODAL DE INFORMACI√ìN */
        /* IMAGEN GRANDE Y RESPONSIVE */
        .info-img { 
            width: 100%; 
            max-height: 250px; 
            object-fit: contain; 
            border-radius: 10px; 
            margin-bottom: 15px; 
            border: 1px solid #eee;
            background: #fff;
        }
        .info-data { text-align: left; margin-top: 15px; font-size: 14px; }
        .info-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px dashed #eee; }
        .info-desc-box { background: #f4f4f4; padding: 10px; margin-top: 10px; border-radius: 8px; font-size: 13px; color: #555; text-align: justify; white-space: pre-wrap; }
        .info-row.highlight { background: #e8f5e9; padding: 10px; border-radius: 8px; border: none; margin-top: 10px; font-weight: bold; color: #2e7d32; }
        
        .close-modal { 
            position: sticky; 
            top: 0; 
            float: right;
            margin-top: -10px;
            margin-right: -10px;
            font-size: 28px; 
            cursor: pointer; 
            color: #555; 
            line-height: 1; 
            z-index: 100; 
            background: rgba(255,255,255,0.9); 
            border-radius: 50%; 
            width: 35px; 
            height: 35px; 
            display: flex; 
            align-items: center; 
            justify-content: center;
        }

        .grid-dias { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 20px; }
        .btn-dia { 
            padding: 10px 5px; border: 1px solid #ddd; border-radius: 8px; 
            background: white; cursor: pointer; font-size: 13px; transition: 0.2s;
        }
        /* D√çA SELECCIONADO EN AZUL CONFIANZA */
        .btn-dia.selected { background: #0D2A52; color: white; border-color: #0D2A52; font-weight: bold; }
        
        .modal-footer { display: flex; gap: 10px; margin-top: auto; }
        .btn-final { flex: 2; padding: 15px; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; color: white; }
        .btn-final.confirmar { background: #25D366; }
        .btn-final.confirmar:disabled { background: #ccc; cursor: not-allowed; }
        .btn-final.cancelar { flex: 1; background: #eee; color: #666; }

        .hidden{display:none}
        input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button{-webkit-appearance:none;margin:0}
        footer{background:#111;color:white;padding:30px 20px 120px;text-align:center;font-size:13px}

        @media print {
            body * { visibility: hidden; }
            #ticket-impresion, #ticket-impresion * { visibility: visible; }
            #ticket-impresion {
                display: block; position: absolute; left: 0; top: 0; width: 100%;
                max-width: 80mm; padding: 5mm; font-family: 'Courier New', monospace;
                font-size: 12px; line-height: 1.2; color: black; background: white;
            }
            .t-center { text-align: center; }
            .t-bold { font-weight: bold; }
            .t-line { border-bottom: 1px dashed #000; margin: 5px 0; }
            .t-flex { display: flex; justify-content: space-between; }
        }
    </style>
</head>
<body>

<div class="header-container">
    <img src="https://lh3.googleusercontent.com/d/1R_i8dF-rqa1UnBGqKCoOT2JysIzvXnE2" alt="Distritodo" class="logo-main">
    <header>
        <span id="menuBtn" onclick="toggleMenu()">‚ò∞</span>
        <input id="buscar" placeholder="Buscar producto o marca..." autocomplete="off">
    </header>
</div>

<div id="sidebar">
    <button class="btn-cerrar-menu" onclick="cerrarMenu()">‚¨Ö Cerrar men√∫</button>
    <div id="verTodos" onclick="limpiarFiltros()">üè† Ver todo el cat√°logo</div>
    <div id="menuCats"></div>
</div>

<div id="marcas"></div>
<div id="contenedor-principal"></div>

<a href="https://wa.me/573224268790?text=Hola,%20necesito%20ayuda%20con%20mi%20pedido" class="btn-soporte" target="_blank">üí¨</a>

<div id="burbuja" onclick="abrirCarrito()">üõí <span id="items">0</span> | $<span id="totalBarra">0</span></div>

<div id="panel">
    <div style="display:flex; justify-content: space-between; align-items: center;">
        <h2>Tu Carrito</h2>
        <button onclick="panel.classList.remove('activo')" style="border:none; background:none; font-size: 20px; cursor:pointer">‚úñ</button>
    </div>

    <div class="cliente-selector">
        <label><b>Datos del Cliente:</b></label>
        <input id="cliente" placeholder="Nombre completo">
        <input id="negocio" placeholder="Nombre del Negocio / Tel√©fono">
        <input id="direccion" placeholder="Direcci√≥n de entrega">
        <select id="tipo">
            <option value="">Tipo cliente</option>
            <option>Nuevo</option>
            <option>Existente</option>
        </select>
        
        <div id="historial-area" class="hidden">
            <p style="font-size:12px; margin: 10px 0 5px;"><b>Clientes guardados:</b></p>
            <select id="select-clientes" onchange="cargarCliente(this.value)">
                <option value="">-- Seleccionar cliente guardado --</option>
            </select>
            <button onclick="eliminarClienteActual()" style="font-size:10px; margin-top:5px; color:red; border:none; background:none; cursor:pointer">Eliminar cliente seleccionado</button>
        </div>
    </div>

    <div id="lista"></div>
    
    <div style="background:#f9f9f9; padding:15px; border-radius:10px; margin-top:15px">
        <div style="display:flex; justify-content:space-between"><span>Subtotal:</span> <span id="subtotal">0</span></div>
        <div style="display:flex; justify-content:space-between; color:green"><span>Ahorro total:</span> <span id="ahorro">0</span></div>
        <hr>
        <div style="display:flex; justify-content:space-between; font-size:20px; font-weight:bold; color:#0D2A52">
            <span>TOTAL:</span> $<span id="total">0</span>
        </div>
    </div>

    <div id="mensaje" style="color:red; font-size:13px; margin:10px 0; text-align:center"></div>
    
    <button id="enviar" onclick="mostrarConfirmacion()" disabled>Enviar pedido por WhatsApp</button>
    <button id="btn-imprimir" onclick="imprimirPedido()" disabled>üñ®Ô∏è Imprimir Pedido (T√©rmica)</button>
    <button class="btn-vaciar" onclick="vaciarCarrito()">Reiniciar / Nuevo Pedido</button>
</div>

<div id="modal-confirmacion">
    <div class="modal-content">
        <span class="close-modal" onclick="cerrarConfirmacion()">√ó</span>
        <img src="https://lh3.googleusercontent.com/d/1O7mf4bEGMpw4oydmktX9hQ1p86JqqPSI" class="modal-logo">
        <div class="modal-title">PREVENTA</div>
        
        <div class="resumen-caja" id="modal-resumen-valores">
            </div>

        <span class="pregunta-dia">¬øCu√°l ser√≠a el d√≠a ideal para llevar tu pedido?</span>
        <div class="grid-dias">
            <button class="btn-dia" onclick="seleccionarDia(this, 'Lunes')">Lunes</button>
            <button class="btn-dia" onclick="seleccionarDia(this, 'Martes')">Martes</button>
            <button class="btn-dia" onclick="seleccionarDia(this, 'Mi√©rcoles')">Mi√©rcoles</button>
            <button class="btn-dia" onclick="seleccionarDia(this, 'Jueves')">Jueves</button>
            <button class="btn-dia" onclick="seleccionarDia(this, 'Viernes')">Viernes</button>
        </div>

        <div class="modal-footer">
            <button class="btn-final cancelar" onclick="cerrarConfirmacion()">Cancelar</button>
            <button class="btn-final confirmar" id="btn-confirmar-wa" disabled onclick="procesarEnvioFinal()">Confirmar y enviar</button>
        </div>
    </div>
</div>

<div id="modal-info">
    <div class="modal-content">
        <span class="close-modal" onclick="cerrarInfo()">√ó</span>
        <div class="modal-title" style="font-size:18px">Detalle del Producto</div>
        <div id="info-contenido"></div>
    </div>
</div>

<div id="ticket-impresion"></div>

<footer>
    <b>Distritodo</b><br>
    Bogot√°<br>
    üì± <a href="https://wa.me/573224268790" style="color:white">3224268790</a><br>
    ‚úâ Nickjair27@gmail.com<br><br>
    ¬© <span id="year"></span>
</footer>

<script>
    year.innerText = new Date().getFullYear();
    const SHEET = "https://docs.google.com/spreadsheets/d/1ICjjEbQBt2Ce9vGj6M3iOMPT9P2ldYVeDLbzV15LMhI/export?format=csv&gid=1965298886";
    const MIN_PEDIDO = 25000;
    const MAX_VALOR = 999;

    let productos = [];
    let marcas = [];
    let carrito = JSON.parse(localStorage.getItem("carrito_distri") || "{}");
    let clientesDB = JSON.parse(localStorage.getItem("clientes_distri") || "[]");
    let marcaFiltro = "";
    let catFiltro = "";
    let diaElegido = "";

    // MEJORA: PERSISTENCIA DE SESI√ìN (DISTRI_SESION)
    // Cargar datos si existen
    const sesion = JSON.parse(localStorage.getItem("distri_sesion") || "{}");
    if(sesion.cliente) cliente.value = sesion.cliente;
    if(sesion.negocio) negocio.value = sesion.negocio;
    if(sesion.direccion) direccion.value = sesion.direccion;
    if(sesion.tipo) tipo.value = sesion.tipo;

    // Guardar datos al escribir
    ["cliente", "negocio", "direccion", "tipo"].forEach(id => {
        document.getElementById(id).addEventListener("input", () => {
            const data = {
                cliente: cliente.value,
                negocio: negocio.value,
                direccion: direccion.value,
                tipo: tipo.value
            };
            localStorage.setItem("distri_sesion", JSON.stringify(data));
            renderCarrito(); // Actualizar validaciones
        });
    });

    fetch(SHEET).then(r => r.text()).then(csv => {
        csv.split(/\r?\n/).slice(1).forEach(f => {
            // Regex para ignorar comas dentro de comillas
            const c = f.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(x => x.replace(/^"|"$/g, '').trim());
            
            if(c[4] === "SI") {
                let nombreLimpio = c[1].replace(/["']/g, "").replace(/[\r\n]+/g, " ").replace(/\s+/g, " ").trim();
                let pBase = parseInt(c[2].replace(/\D/g,"")) || 0;
                let dPorc = parseInt(c[8]) || 0;
                let pvp = parseInt(c[13].replace(/\D/g,"")) || 0; 
                let descripcionExtra = c[15]; 

                productos.push({ 
                    n: nombreLimpio, 
                    pOrig: pBase, 
                    p: dPorc > 0 ? Math.round(pBase * (1 - dPorc/100)) : pBase, 
                    img: c[3], 
                    premium: c[5] === "SI", 
                    marca: c[6], 
                    cat: c[7], 
                    desc: dPorc,
                    pvp: pvp,
                    info: descripcionExtra 
                });
            }
            if(c[9] && c[11] === "SI" && c[10]) if(!marcas.find(m => m.nombre === c[9])) marcas.push({ nombre: c[9], logo: c[10] });
        });
        marcas = marcas.filter(m => productos.some(p => p.marca === m.nombre));
        renderSidebar(); renderMarcas(); renderProductos(); renderCarrito(); actualizarSelectClientes();
    });

    function toggleMenu() { sidebar.classList.toggle("activo"); }
    function cerrarMenu() { sidebar.classList.remove("activo"); }
    function limpiarFiltros() { marcaFiltro = ""; catFiltro = ""; buscar.value = ""; cerrarMenu(); renderProductos(); }

    function renderSidebar() {
        const cats = [...new Set(productos.map(p => p.cat).filter(Boolean))];
        let h = ""; cats.forEach(c => h += `<div class="cat" onclick="filtrarCat('${c}')">${c}</div>`);
        menuCats.innerHTML = h;
    }

    function filtrarCat(c) { catFiltro = c; marcaFiltro = ""; buscar.value = ""; cerrarMenu(); renderProductos(); }

    function renderMarcas() {
        marcasDiv.innerHTML = "";
        marcas.forEach(m => {
            marcasDiv.innerHTML += `<div class="marca" onclick="filtrarMarca('${m.nombre}')"><img src="${m.logo}"><div>${m.nombre}</div></div>`;
        });
    }

    function filtrarMarca(m) { marcaFiltro = m; catFiltro = ""; buscar.value = ""; renderProductos(); }

    buscar.oninput = () => { if(buscar.value.trim() !== "") { catFiltro = ""; marcaFiltro = ""; } renderProductos(); };

    const prodContenedor = document.getElementById("contenedor-principal");
    const marcasDiv = document.getElementById("marcas");

    function renderProductos() {
        prodContenedor.innerHTML = "";
        let b = buscar.value.toLowerCase();
        let f = productos.filter(p => (p.n.toLowerCase().includes(b) || p.marca.toLowerCase().includes(b)) && (!catFiltro || p.cat === catFiltro) && (!marcaFiltro || p.marca === marcaFiltro));
        let cats = [...new Set(f.map(p => p.cat))];
        let promos = f.filter(p => p.desc > 0);
        if (promos.length > 0 && !catFiltro && !marcaFiltro) renderSeccion("üî• PROMOCIONES", promos);
        cats.forEach(c => { let pc = f.filter(p => p.cat === c); if(pc.length > 0) renderSeccion(c, pc); });
    }

    function renderSeccion(titulo, lista) {
        let s = document.createElement("div"); s.innerHTML = `<div class="seccion-titulo">${titulo}</div>`;
        let g = document.createElement("div"); g.id = "productos";
        lista.forEach(p => {
            const cant = carrito[p.n]?.c || 0;
            // MEJORA: Estructura para posicionar bot√≥n info abajo derecha
            g.innerHTML += `
                <div class="producto ${p.premium ? 'premium' : ''}" data-name="${p.n}">
                    <div style="position:relative; width:100%">
                        ${p.premium ? '<span class="premium-tag">PREMIUM</span>' : ''}
                        ${p.desc > 0 ? `<span class="badge-desc">-${p.desc}%</span>` : ''}
                        <div class="btn-info" onclick="abrirInfoProducto('${p.n}')">‚ÑπÔ∏è</div>
                        <img src="${p.img}">
                    </div>
                    <div class="nombre">${p.n}</div>
                    <div class="precio">${p.desc > 0 ? `<span class="precio-old">$${p.pOrig.toLocaleString()}</span>` : ''} $${p.p.toLocaleString()}</div>
                    <div class="controles">
                        <button onclick="chg('${p.n}', -1)">‚àí</button>
                        <input type="number" value="${cant}" oninput="validarCant(this)" onchange="set('${p.n}', this.value)" onfocus="this.select()">
                        <button onclick="chg('${p.n}', 1)">+</button>
                    </div>
                </div>`;
        });
        s.appendChild(g); prodContenedor.appendChild(s);
    }

    function abrirInfoProducto(nombre) {
        const p = productos.find(x => x.n === nombre);
        if (!p) return;

        let costoCliente = p.p; 
        let pvp = p.pvp; 
        let ganancia = pvp > 0 ? pvp - costoCliente : 0;
        let rentabilidadPorc = (pvp > 0 && costoCliente > 0) ? Math.round((ganancia / costoCliente) * 100) : 0;

        let html = `
            <img src="${p.img}" class="info-img">
            <h3 style="margin:0 0 10px; color:#0D2A52">${p.n}</h3>
            <div class="info-data">
                <div class="info-row">
                    <span>Costo Producto:</span>
                    <b>$${costoCliente.toLocaleString()}</b>
                </div>
                <div class="info-row">
                    <span>Sugerido al P√∫blico:</span>
                    <b>${pvp > 0 ? '$'+pvp.toLocaleString() : 'N/A'}</b>
                </div>
                ${pvp > 0 ? `
                <div class="info-row highlight">
                    <span>üí∞ Rentabilidad:</span>
                    <span>$${ganancia.toLocaleString()} (${rentabilidadPorc}%)</span>
                </div>` : ''}
                
                ${p.info ? `
                <div class="info-desc-box">
                    <b>Descripci√≥n / Detalles:</b><br>
                    ${p.info}
                </div>` : ''}
            </div>
            <button onclick="cerrarInfo()" style="margin-top:20px; width:100%; padding:10px; background:#0D2A52; color:white; border:none; border-radius:8px; font-weight:bold; cursor:pointer">Entendido</button>
        `;

        document.getElementById('info-contenido').innerHTML = html;
        document.getElementById('modal-info').style.display = 'flex';
    }

    function cerrarInfo() {
        document.getElementById('modal-info').style.display = 'none';
    }

    function validarCant(el) {
        if(el.value.length > 3) el.value = el.value.slice(0, 3);
        if(parseInt(el.value) > MAX_VALOR) el.value = MAX_VALOR;
    }

    function chg(n, v) {
        let c = (carrito[n]?.c || 0) + v;
        if(c > MAX_VALOR) c = MAX_VALOR;
        if(c <= 0) delete carrito[n]; 
        else { const p = productos.find(x => x.n === n); carrito[n] = { c, pr: p.p, po: p.pOrig, prem: p.premium }; }
        save(); renderCarrito(); 
        actualizarInputProducto(n, carrito[n] ? carrito[n].c : 0);
    }

    function set(n, v) {
        let num = parseInt(v) || 0;
        if(num > MAX_VALOR) num = MAX_VALOR;
        if(num <= 0) delete carrito[n]; 
        else { const p = productos.find(x => x.n === n); carrito[n] = { c: num, pr: p.p, po: p.pOrig, prem: p.premium }; }
        save(); renderCarrito();
        actualizarInputProducto(n, carrito[n] ? carrito[n].c : 0);
    }

    function actualizarInputProducto(nombre, cantidad) {
        document.querySelectorAll('.producto').forEach(p => {
            if(p.getAttribute('data-name') === nombre) {
                const input = p.querySelector('input');
                if(input) input.value = cantidad;
            }
        });
    }

    function renderCarrito() {
        let tot = 0, sub = 0, itemC = 0, h = "";
        for(let k in carrito) {
            let i = carrito[k]; tot += i.pr * i.c; sub += i.po * i.c; itemC += i.c;
            h += `<div class="item ${i.prem ? 'premium' : ''}"><div class="item-info"><div><b>${k}</b></div><div style="font-size:12px; color:#0D2A52">$${i.pr.toLocaleString()} c/u</div></div><div class="controles"><button onclick="chg('${k}',-1)">‚àí</button><input type="number" value="${i.c}" oninput="validarCant(this)" onchange="set('${k}', this.value)"><button onclick="chg('${k}',1)">+</button></div></div>`;
        }
        lista.innerHTML = h || "<p style='text-align:center; color:#999'>El carrito est√° vac√≠o</p>";
        document.getElementById('total').innerText = tot.toLocaleString(); 
        document.getElementById('totalBarra').innerText = tot.toLocaleString();
        document.getElementById('subtotal').innerText = "$" + sub.toLocaleString(); 
        document.getElementById('ahorro').innerText = "- $" + (sub - tot).toLocaleString();
        document.getElementById('items').innerText = itemC;
        document.getElementById('mensaje').innerText = tot < MIN_PEDIDO ? `Pedido m√≠nimo: $${MIN_PEDIDO.toLocaleString()}` : "";
        const ok = cliente.value && negocio.value && direccion.value && tipo.value && tot >= MIN_PEDIDO;
        document.getElementById('enviar').disabled = !ok; 
        document.getElementById('btn-imprimir').disabled = !ok;
    }

    function save() { localStorage.setItem("carrito_distri", JSON.stringify(carrito)); }
    function vaciarCarrito() { if(confirm("¬øDeseas vaciar el carrito?")) { carrito = {}; save(); renderCarrito(); renderProductos(); } }
    function abrirCarrito() { panel.classList.add('activo'); if(clientesDB.length > 0) historialArea.classList.remove("hidden"); }

    const historialArea = document.getElementById("historial-area");
    // Se elimin√≥ la asignaci√≥n antigua de oninput porque ahora lo manejamos con el Listener de sesi√≥n

    function mostrarConfirmacion() {
        diaElegido = "";
        document.querySelectorAll('.btn-dia').forEach(b => b.classList.remove('selected'));
        document.getElementById('btn-confirmar-wa').disabled = true;
        document.getElementById('modal-resumen-valores').innerHTML = `
            <div class="resumen-linea"><span>Subtotal:</span> <span>${document.getElementById('subtotal').innerText}</span></div>
            <div class="resumen-linea" style="color:green"><span>Descuento:</span> <span>${document.getElementById('ahorro').innerText}</span></div>
            <div class="resumen-linea" style="font-weight:bold; font-size:16px; margin-top:10px; color:#0D2A52"><span>Total a pagar:</span> <span>$${document.getElementById('total').innerText}</span></div>
        `;
        document.getElementById('modal-confirmacion').style.display = 'flex';
    }

    function seleccionarDia(btn, dia) {
        diaElegido = dia;
        document.querySelectorAll('.btn-dia').forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
        document.getElementById('btn-confirmar-wa').disabled = false;
    }

    function cerrarConfirmacion() { document.getElementById('modal-confirmacion').style.display = 'none'; }

    function procesarEnvioFinal() {
        guardarClienteLocal();
        let sub = 0, tot = 0, msgItems = "";
        const safe = (txt) => encodeURIComponent(txt);
        for(let k in carrito) {
            let i = carrito[k]; sub += i.po * i.c; tot += i.pr * i.c;
            msgItems += `‚Ä¢ ${i.c} x ${safe(k)}%0A`;
        }
        let ahr = sub - tot;
        let m = `Hola, te compartimos el resumen de tu pedido y algunos detalles para coordinar la entrega.%0A%0A`;
        m += `*D√≠a ideal de entrega:* ${diaElegido}%0A%0A`;
        m += `*DETALLES DEL CLIENTE*%0A`;
        m += `--------------------------------%0A`;
        m += `*Cliente:* ${safe(cliente.value)}%0A*Negocio:* ${safe(negocio.value)}%0A*Direcci√≥n:* ${safe(direccion.value)}%0A*Tipo:* ${safe(tipo.value)}%0A`;
        m += `--------------------------------%0A%0A`;
        m += `*RESUMEN DEL PEDIDO*%0A`;
        m += `${msgItems}%0A`;
        m += `--------------------------------%0A`;
        m += `*SUBTOTAL:* $${sub.toLocaleString()}%0A`;
        m += `*DESCUENTOS:* -$${ahr.toLocaleString()}%0A`;
        m += `*TOTAL A PAGAR:* $${tot.toLocaleString()}%0A`;
        m += `--------------------------------%0A`;
        if(ahr > 0) m += `*¬°Ahorro obtenido: $${ahr.toLocaleString()}!*%0A`;
        
        window.open("https://wa.me/573224268790?text=" + m);
        cerrarConfirmacion();
    }

    function guardarClienteLocal() {
        if(!cliente.value) return;
        let idx = clientesDB.findIndex(c => c.nombre === cliente.value);
        let d = { nombre: cliente.value, negocio: negocio.value, dir: direccion.value, tipo: tipo.value, ultimoPedido: {...carrito} };
        if(idx > -1) clientesDB[idx] = d; else clientesDB.push(d);
        localStorage.setItem("clientes_distri", JSON.stringify(clientesDB));
        actualizarSelectClientes();
    }

    function actualizarSelectClientes() {
        const s = document.getElementById("select-clientes");
        s.innerHTML = '<option value="">-- Seleccionar cliente guardado --</option>';
        clientesDB.forEach(c => s.innerHTML += `<option value="${c.nombre}">${c.nombre} (${c.negocio})</option>`);
        if(clientesDB.length > 0) historialArea.classList.remove("hidden");
    }

    function cargarCliente(n) {
        if(!n) return;
        const c = clientesDB.find(x => x.nombre === n);
        if(c) {
            cliente.value = c.nombre; negocio.value = c.negocio; direccion.value = c.dir; tipo.value = c.tipo;
            if(c.ultimoPedido && Object.keys(c.ultimoPedido).length > 0) {
                if(confirm("¬øCargar √∫ltimo pedido guardado para este cliente?")) { 
                    carrito = {...c.ultimoPedido}; 
                    save(); 
                }
            }
            // Actualizar tambi√©n la sesi√≥n para persistencia inmediata
            const data = { cliente: c.nombre, negocio: c.negocio, direccion: c.dir, tipo: c.tipo };
            localStorage.setItem("distri_sesion", JSON.stringify(data));
            
            renderCarrito();
            renderProductos();
        }
    }

    function eliminarClienteActual() {
        const n = document.getElementById("select-clientes").value;
        if(n && confirm("¬øEliminar cliente?")) {
            clientesDB = clientesDB.filter(c => c.nombre !== n);
            localStorage.setItem("clientes_distri", JSON.stringify(clientesDB));
            actualizarSelectClientes();
        }
    }

    function imprimirPedido() {
        guardarClienteLocal();
        const f = new Date().toLocaleString();
        let sub = 0, tot = 0, hI = "";
        for(let k in carrito) {
            let i = carrito[k]; sub += i.po * i.c; tot += i.pr * i.c;
            hI += `<div class="t-flex"><span style="width:15%">${i.c} x</span><span style="width:55%">${k}</span><span style="width:30%; text-align:right">$${(i.pr * i.c).toLocaleString()}</span></div>`;
        }
        const ticketDiv = document.getElementById("ticket-impresion");
        ticketDiv.innerHTML = `<div class="t-center t-bold" style="font-size:16px">Distritodo</div><div class="t-center">NO RESPONSABLE DE IVA</div><div class="t-line"></div><div><b>FECHA:</b> ${f}</div><div><b>CLIENTE:</b> ${cliente.value}</div><div><b>NEGOCIO:</b> ${negocio.value}</div><div class="t-line"></div>${hI}<div class="t-line"></div><div class="t-flex"><span>TOTAL A PAGAR:</span> <b>$${tot.toLocaleString()}</b></div><div class="t-center" style="margin-top:10px">¬°Gracias por su compra!</div>`;
        window.print();
    }
</script>

</body>
</html>
